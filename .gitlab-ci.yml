image: hyperized/yaml-linter:latest

stages:
  - yaml
  - syntax
  - execute

# If this does not passes, don't bother even trying Ansible :)
yaml_lint:
  stage: yaml
  script:
    - yaml-lint -i -q .

# Ansible based syntax check
.syntax_check: &syntax
  stage: syntax
  before_script:
    - mkdir -p /etc/ansible/roles/`basename "$PWD"` && cp -R * /etc/ansible/roles/`basename "$PWD"`
  script:
    - ansible --version
    - ansible-playbook --syntax-check tests/main.yml

.execute: &execute
  stage: execute
  before_script:
    - mkdir -p /etc/ansible/roles/`basename "$PWD"` && cp -R * /etc/ansible/roles/`basename "$PWD"`
  script:
    - ansible-playbook tests/main.yml

# Do checks on all versions
syntax-ansible2.5:
  <<: *syntax
  image: hyperized/ansible-docker:2.5

syntax-ansible2.6:
  <<: *syntax
  image: hyperized/ansible-docker:2.6

syntax-ansible2.7:
  <<: *syntax
  image: hyperized/ansible-docker:2.7

# Do checks on all versions
execute-ansible2.5:
  <<: *execute
  image: hyperized/ansible-docker:2.5

execute-ansible2.6:
  <<: *execute
  image: hyperized/ansible-docker:2.6

execute-ansible2.7:
  <<: *execute
  image: hyperized/ansible-docker:2.7
